<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gxu.tour.mapper.UserAndLogMapping">
    <resultMap id="userResult" type="User">
        <id property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="userSex" column="user_sex"/>
        <result property="userAge" column="user_age"/>
        <result property="province" column="province"/>
    </resultMap>

    <resultMap id="logResult" type="Log">
        <id property="logId" column="log_id"/>
        <result property="userId" column="user_id" javaType="Integer"/>
        <result property="productType" column="product_type"/>
        <result property="productName" column="product_name"/>
        <result property="behaviorType" column="behavior_type"/>
        <result property="fromTerminal" column="from_terminal"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <resultMap id="identityResult" type="Identity">
        <result property="total" column="total"/>
        <result property="mNumber" column="mnumber"/>
        <result property="wNumber" column="wnumber"/>
        <result property="yearAndMonth" column="mon"/>
    </resultMap>



    <!--    public User getUserById(Integer id);-->
    <select id="getUserById" resultType="com.gxu.tour.entity.User">
    select * from user where user_id=#{id}
  </select>

    <!--    public List<User> getAllUser();-->
    <select id="getAllUser" resultMap="userResult">
        select * from  user
    </select>

    <!--    查询单个用户-->
    <select id="getLogById" resultMap="logResult">
        select * from log where log_id=#{id}
    </select>

    <!--    public SoucreOfAccess  geNumbersOfAccessSource(@Param("year")Integer year, @Param("month") Integer month);-->
    <select id="getNumbersOfAccessSource" resultType="SoucreOfAccess">
        SELECT SUM(CASE WHEN from_terminal =1 THEN 1 ELSE 0 END) MP,
	        SUM(CASE WHEN from_terminal=0 THEN 1 ELSE 0 END) PC
            FROM log WHERE  YEAR(create_time)=#{year} AND MONTH(create_time)=#{month};
    </select>


    <!--    查询和统计最近一年每个月的身份统计数据
            mnumber性别为男的数量
            wnumber性别为女性的数量
            total总人数
            mon年份和月份
    -->
    <select id="getVisitorIdentityStatistics" resultMap="identityResult">
    SELECT COUNT(*) AS total,
    SUM(IF( b.`user_sex`='男', 1,0)) AS 'mnumber',
    SUM(IF( b.`user_sex`='女', 1,0)) AS 'wnumber',
    a.`create_time`  AS 'mon' FROM log AS a, user AS b
    WHERE DATE_FORMAT(a.create_time, '%Y-%m') > DATE_FORMAT(DATE_SUB("2017-01-02 09:10:23", INTERVAL 12 MONTH), '%Y-%m') AND a.`user_id` = b.`user_id` GROUP BY mon;
    </select>
</mapper>
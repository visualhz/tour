<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gxu.tour.mapper.UserAndLogMapping">

    <resultMap id="fromTerminalResult" type="FromTerminal">
        <result property="year" column="year"/>
        <result property="month" column="month"/>
        <result property="MP" column="MP"/>
        <result property="PC" column="PC"/>
        <result property="IM" column="IM"/>
    </resultMap>


    <resultMap id="sexByMonthResult" type="Sex">
        <result property="year" column="year"/>
        <result property="month" column="month"/>
        <result property="manNum" column="man_num"/>
        <result property="womenNum" column="women_num"/>
        <result property="total" column="total"/>
    </resultMap>



    <!-- fromTerminalResult查询出访问入口的人数
     '0 | pc端 ; 1 | 小程序端 ； 2 | 一体机 ；'
     -->
    <select id="getFromTerminalStatistic" resultMap="fromTerminalResult">
        SELECT year, month, PC, MP, IM  FROM from_terminal_result a
        WHERE NOT EXISTS( SELECT * FROM from_terminal_result b
        WHERE a.`year` = b.`year` AND a.`month` = b.`month`
        AND a.`create_time` &lt; b.`create_time`) ORDER BY a.`year`, a.`month` DESC LIMIT 0,1;
    </select>

    <select id="getSexByMonthStatistic" resultMap="sexByMonthResult">

        SELECT year, month, man_num, women_num, total FROM sexByMonth a
        WHERE NOT EXISTS(SELECT * FROM sexByMonth b
        WHERE a.`year` =b.`year` AND a.`month` = b.`month` AND a.`create_time`  &lt; b.`create_time`)
        ORDER BY YEAR, MONTH LIMIT 0,12;
    </select>



    <!--    从syd_tourshow_watch_log中查出当月的浏览数据
            插入到from_terminal_result表中。
            -->
    <insert id="refreshFromTerminalStatistic">
        INSERT INTO from_terminal_result(YEAR,MONTH,PC,MP,IM)
        SELECT YEAR(create_time)AS 'year',
        MONTH(create_time) AS 'mon',
        SUM(IF (from_terminal=0,1,0)) AS 'PC',
        SUM(IF (from_terminal=1,1,0)) AS 'MP',
        SUM(IF (from_terminal=2,1,0)) AS 'IM'
        FROM syd_tourshow_watch_log
        <if test="choose==true">
            WHERE YEAR(create_time)=YEAR(CURRENT_TIMESTAMP) AND MONTH(create_time)=MONTH (CURRENT_TIMESTAMP )
        </if>
        GROUP BY MONTH(create_time),YEAR(create_time);

    </insert>

    <insert id="refreshSexByMonthStatistic">
    INSERT INTO sexByMonth(YEAR,MONTH,man_num,women_num,total)
    SELECT YEAR(lo.`create_time`) AS 'year',
    MONTH(lo.`create_time`) AS 'month',
    SUM(IF(us.`sex`=0,1,0)) AS 'man',
    SUM(IF(us.`sex`=1,1,0)) AS 'women',
    COUNT(*) AS 'total'
    FROM syd_tourshow_user us
    INNER JOIN `syd_tourshow_watch_log` lo ON us.`uid` = lo.`uid`
    WHERE DATE_FORMAT(lo.`create_time`,'%Y-%m') > DATE_FORMAT(DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 12 MONTH),'%Y-%m')
    GROUP BY YEAR, MONTH;
    </insert>



</mapper>